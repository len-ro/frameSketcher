
var frames;var cnt=0;var drawParams;var frameData;var frameName;function checkCanvas(){var canvas2DSupported=!!window.CanvasRenderingContext2D;if(!canvas2DSupported){var docHeight=$(document).height();$("body").append("<div id='overlay'>HTML5 Canvas, as required by this application<br/>is not supported in this browser!<br/>Try <a href='http://en.wikipedia.org/wiki/Canvas_element#Support'>another</a>!</div>");$("#overlay").height(docHeight).css({'font-size':'180%','font-weight':'bold','padding-top':200,'vertical-align':'middle','text-align':'center','color':'red','opacity':0.8,'position':'absolute','top':0,'left':0,'background-color':'black','width':'100%','z-index':5000});return;}}
$(document).ready(function(){checkCanvas();var ref=getUrlVars()['ref'];if(ref==undefined){ref='frames';}
$.ajax({type:'GET',url:ref+'.json',dataType:'json',cache:false,success:function(aData){frames=aData;$('#frames').get(0).options.length=0;$('#frames').get(0).options[0]=new Option("--Select--","0");$.each(aData,function(i,item){$('#frames').get(0).options[$('#frames').get(0).options.length]=new Option(item.name,item.id);});drawParams=initDrawParams('frameCanvas');clear(true,true);$('#frames').change(function(){loadFrameData();});$('#draw').click(function(){draw();window.scrollTo(0,0);});$('#clear').click(function(){clear(true,true);});},error:function(){alert("Connection is not available!");}});});function cos(angle){return Math.cos(angle*Math.PI/180);}
function sin(angle){return Math.sin(angle*Math.PI/180);}
function asin(val){return Math.asin(val)*180/Math.PI;}
function ctg(angle){return 1/Math.tan(angle*Math.PI/180);}
function initDrawParams(canvasName){var canvas=document.getElementById(canvasName);var params={};params['canvasName']=canvasName;params['x0']=canvas.width*.45;params['y0']=canvas.height*.9;params['scale']=canvas.height/1250;return params;}
function checkData(){frameData={}
var check=['BB','CS','ST','STCC','WB','HT'];for(var i=0;i<check.length;i++){var item=check[i];var x=parseInt($('#'+item).val());if(isNaN(x)){alert('Missing or invalid: '+item+'!');return false;}
frameData[item]=x;}
check=['STA','HTA'];for(var i=0;i<check.length;i++){var item=check[i];var x=parseFloat($('#'+item).val());if(isNaN(x)){alert('Missing or invalid: '+item+'!');return false;}
frameData[item]=x;}
var RE=parseInt($('#RE').val());var SK=parseInt($('#SK').val());var TT=parseInt($('#TT').val());var TTT=parseInt($('#TTT').val());if((isNaN(RE)||isNaN(SK))&&(isNaN(TT)||isNaN(TTT))){alert('RE & SK or TT && TTT are required!');return false;}
if(isNaN(RE)||isNaN(SK)){frameData['TT']=TT;frameData['TTT']=TTT;var h1=frameData['STCC']*sin(frameData['STA']);var beta=asin(frameData['TT']*sin(frameData['STA'])/frameData['TTT']);var h2=frameData['TTT']*sin(frameData['STA']+beta);frameData['SK']=h1+h2;frameData['RE']=frameData['TT']-frameData['SK']*ctg(frameData['STA']);$('#RE').val(frameData['RE']);$('#SK').val(frameData['SK']);}else{frameData['SK']=SK;frameData['RE']=RE;frameData['TT']=frameData['SK']*ctg(frameData['STA'])+frameData['RE'];$('#TT').val(frameData['TT']);AB=frameData['SK']/sin(frameData['STA'])-frameData['STCC'];AC=frameData['TT']-frameData['RE']-frameData['STCC']*cos(frameData['STA']);frameData['TTT']=Math.sqrt(AB*AB+frameData['TT']*frameData['TT']-2*frameData['TT']*AC);$('#TTT').val(frameData['TTT']);var beta=asin(frameData['TT']*sin(frameData['STA'])/frameData['TTT']);}
frameData['WS']=$('#WS').val();if(frameData['WS']=='29'){frameData['WSM']=373;}else{frameData['WSM']=342;}
var SH=parseInt($('#SH').val());if(isNaN(SH)){frameData['SH']=frameData['WSM']-frameData['BB']+sin(frameData['STA'])*frameData['STCC']+sin(beta+frameData['STA'])*frameData['TTT']/2;$('#SH').val(frameData['SH']);}
return true;}
function draw(){if(!checkData())return;if(cnt==0){clear(false,false);}
drawInseam();var color=$('#color').val();color="#"+color;drawFrame(frameData,color);}
function drawInseam(){var inseam=parseInt($('#inseam').val(),10);if(inseam==NaN)return;var canvas=document.getElementById(drawParams.canvasName);var context=canvas.getContext('2d');context.save();context.translate(drawParams.x0,drawParams.y0)
context.scale(drawParams.scale,drawParams.scale);context.lineWidth=1;context.beginPath();context.moveTo(-450,-inseam);context.lineTo(700,-inseam);context.closePath();context.stroke();context.restore();}
function drawFrame(fp,color){var canvas=document.getElementById(drawParams.canvasName);var context=canvas.getContext('2d');xp1=0;yp1=-fp['WSM']+fp['BB'];xp2=xp1-Math.sqrt(fp['CS']*fp['CS']-fp['BB']*fp['BB']);yp2=-fp['WSM'];xp3=xp1-(fp['STCC']*cos(fp['STA']));yp3=yp1-(fp['STCC']*sin(fp['STA']));xp4=xp1-(fp['ST']*cos(fp['STA']));yp4=yp1-(fp['ST']*sin(fp['STA']));xp5=xp2+fp['WB'];yp5=yp2;xp6=xp1+fp['RE'];yp6=yp1-fp['BB']-fp['SK'];xp7=xp6+fp['HT']*cos(fp['HTA']);yp7=yp6+fp['HT']*sin(fp['HTA']);context.fillStyle=color;context.font="bold 12px sans-serif";context.fillText(frameName,10,15+cnt*20);cnt++;context.save();context.translate(drawParams.x0,drawParams.y0)
context.scale(drawParams.scale,drawParams.scale);context.strokeStyle=color;context.lineWidth=2/drawParams.scale;context.beginPath();context.moveTo(xp1,yp1);context.lineTo(xp2,yp2);context.moveTo(xp1,yp1);context.lineTo(xp4,yp4);context.moveTo(xp3,yp3);context.lineTo(xp6,yp6);context.lineTo(xp7,yp7);context.lineTo(xp1,yp1);context.moveTo(xp2,yp2);context.lineTo(xp3,yp3);context.closePath();context.stroke();context.beginPath();context.arc(xp2,yp2,fp['WSM'],0,2*Math.PI,false);context.closePath();context.stroke();context.beginPath();context.arc(xp5,yp5,fp['WSM'],0,2*Math.PI,false);context.closePath();context.stroke();context.restore();}
function clear(eraseData,drawInfo){var canvas=document.getElementById(drawParams.canvasName);var context=canvas.getContext('2d');if(eraseData){cnt=0;frameData=null;frameName="Custom";$('#frames').val(0);loadFrameData();$('#inseam').val('');}
context.clearRect(0,0,canvas.width,canvas.height);canvas.width=canvas.width;if(drawInfo){var img=new Image();img.onload=function(){context.drawImage(img,0,0);};img.src='doc/draw.png';}}
function loadFrameData(){$('.frameDataInput').each(function(i){$(this).val('');});v=$('#frames').val();if(v!='0'){frameData=frames[v];$.each(frameData.params,function(i,item){$('#'+i).val(item);});frameName=frameData.name;}else{frameData=null;frameName="Custom";$('#WS').val('26');}}
function getUrlVars(){var vars=[],hash;var hashes=window.location.href.slice(window.location.href.indexOf('?')+1).split('&');for(var i=0;i<hashes.length;i++){hash=hashes[i].split('=');vars.push(hash[0]);vars[hash[0]]=hash[1];}
return vars;}